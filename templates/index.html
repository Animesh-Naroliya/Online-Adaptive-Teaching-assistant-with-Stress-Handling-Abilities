<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emotion-Aware Virtual Teaching Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vanta@latest/dist/vanta.globe.min.js"></script>
    <style>
        .gateway-form {
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .path-card {
            transition: all 0.5s ease;
            transform-style: preserve-3d;
        }

        .path-card:hover {
            transform: translateY(-10px) scale(1.05);
        }

        .interest-orb {
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .interest-orb:hover {
            transform: scale(1.2);
            filter: drop-shadow(0 0 10px rgba(255, 255, 255, 0.7));
        }

        .selected-orb {
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0% {
                transform: translateY(0px);
            }

            50% {
                transform: translateY(-20px);
            }

            100% {
                transform: translateY(0px);
            }
        }

        .fade-in {
            animation: fadeIn 1.5s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .slide-up {
            animation: slideUp 1s ease-out;
        }

        @keyframes slideUp {
            from {
                transform: translateY(100px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .tts-button {
            background: none;
            border: none;
            color: #4CAF50;
            cursor: pointer;
            font-size: 1em;
            margin-left: 8px;
            padding: 0;
            outline: none;
            transition: color 0.2s;
            line-height: 1;
        }

        .tts-button:hover {
            color: #388E3C;
        }

        .vta-text-content * {
            margin-bottom: 0.5rem;
            line-height: 1.5;
        }

        .vta-text-content ul,
        .vta-text-content ol {
            margin-left: 1.5rem;
            list-style-position: outside;
        }

        .vta-text-content h1,
        .vta-text-content h2,
        .vta-text-content h3 {
            font-weight: bold;
            margin-top: 1rem;
        }
    </style>
</head>

<body class="min-h-screen bg-gray-900 text-white overflow-x-hidden" id="vanta-bg">
    <div id="stage-1" class="min-h-screen flex items-center justify-center fade-in">
        <div class="gateway-form p-10 max-w-md w-full text-center" data-aos="zoom-in">
            <h1 class="text-4xl font-bold mb-6">Welcome Learner</h1>
            <p class="mb-8 text-gray-300">Step through the gateway to begin your journey</p>

            <div class="mb-4">
                <input type="email" placeholder="Your Email or Username"
                    class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
            </div>
            <div class="mb-6">
                <input type="password" placeholder="Your Password"
                    class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
            </div>

            <button id="login-btn"
                class="w-full bg-gradient-to-r from-purple-600 to-blue-500 py-3 rounded-lg font-medium hover:opacity-90 transition-all duration-300">
                Enter the Gateway
            </button>

            <div class="mt-4 text-sm text-gray-400">
                Don't have account?
                <a href="#" id="show-signup" class="text-purple-400 underline">Signup</a>
            </div>
        </div>
    </div>
    <div id="signup-page" class="min-h-screen hidden flex items-center justify-center fade-in">
        <div class="gateway-form p-10 max-w-md w-full text-center" data-aos="zoom-in">
            <h1 class="text-4xl font-bold mb-6">Sign Up</h1>
            <p class="mb-8 text-gray-300">Please fill in this form to create an account.</p>

            <form id="signup-form" onsubmit="return false;">
                <div class="mb-4">
                    <input type="text" id="signup-name" placeholder="Full Name"
                        class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                        required>
                </div>
                <div class="mb-4">
                    <input type="text" id="signup-username" placeholder="Username"
                        class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                        required>
                </div>
                <div class="mb-4">
                    <input type="email" id="signup-email" placeholder="Email (example@email.com)"
                        class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                        required>
                </div>
                <div class="mb-4">
                    <input type="password" id="signup-password" placeholder="Password" minlength="8"
                        class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                        required>
                </div>
                <div class="mb-4">
                    <input type="password" id="signup-repeat" placeholder="Confirm Password" minlength="8"
                        class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                        required>
                </div>
                <button type="button" id="signup-btn"
                    class="w-full bg-gradient-to-r from-purple-600 to-blue-500 py-3 rounded-lg font-medium hover:opacity-90 transition-all duration-300">
                    Create Account
                </button>
            </form>

            <div class="mt-6 text-sm text-gray-400">
                <a href="#" id="back-to-login" class="text-purple-400 underline">Already have account? Login</a>
            </div>
        </div>
    </div>
    <div id="stage-2" class="min-h-screen hidden flex items-center justify-center p-6">
        <div class="gateway-form p-10 max-w-4xl w-full text-center" data-aos="zoom-in">
            <h1 class="text-4xl font-bold mb-4">Tell Us About Yourself</h1>
            <p class="text-xl text-gray-300 mb-12">"Help us understand your preferences to personalize your experience"
            </p>

            <div class="space-y-8">
                <div class="bg-gradient-to-br from-green-900 to-gray-900 p-8 rounded-2xl">
                    <h3 class="text-2xl font-semibold text-center text-green-400 mb-6">What do you like? üíö</h3>
                    <p class="text-gray-300 text-center mb-6">Tell us about your interests, hobbies, or things you enjoy
                    </p>

                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6">
                        <button
                            class="like-option p-3 bg-gray-800 hover:bg-green-700 rounded-lg text-sm transition-all duration-300"
                            onclick="toggleSelection(this, 'like')">Reading</button>
                        <button
                            class="like-option p-3 bg-gray-800 hover:bg-green-700 rounded-lg text-sm transition-all duration-300"
                            onclick="toggleSelection(this, 'like')">Sports</button>
                        <button
                            class="like-option p-3 bg-gray-800 hover:bg-green-700 rounded-lg text-sm transition-all duration-300"
                            onclick="toggleSelection(this, 'like')">Music</button>
                        <button
                            class="like-option p-3 bg-gray-800 hover:bg-green-700 rounded-lg text-sm transition-all duration-300"
                            onclick="toggleSelection(this, 'like')">Movies</button>
                        <button
                            class="like-option p-3 bg-gray-800 hover:bg-green-700 rounded-lg text-sm transition-all duration-300"
                            onclick="toggleSelection(this, 'like')">Cooking</button>
                        <button
                            class="like-option p-3 bg-gray-800 hover:bg-green-700 rounded-lg text-sm transition-all duration-300"
                            onclick="toggleSelection(this, 'like')">Travel</button>
                        <button
                            class="like-option p-3 bg-gray-800 hover:bg-green-700 rounded-lg text-sm transition-all duration-300"
                            onclick="toggleSelection(this, 'like')">Gaming</button>
                        <button
                            class="like-option p-3 bg-gray-800 hover:bg-green-700 rounded-lg text-sm transition-all duration-300"
                            onclick="toggleSelection(this, 'like')">Art</button>
                    </div>

                    <textarea id="custom-likes" placeholder="Or write your own interests here..."
                        class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 text-white resize-none"
                        rows="3"></textarea>
                </div>

                <div class="bg-gradient-to-br from-red-900 to-gray-900 p-8 rounded-2xl">
                    <h3 class="text-2xl font-semibold text-center text-red-400 mb-6">What do you dislike? üíî</h3>
                    <p class="text-gray-300 text-center mb-6">Tell us about things you prefer to avoid</p>

                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6">
                        <button
                            class="dislike-option p-3 bg-gray-800 hover:bg-red-700 rounded-lg text-sm transition-all duration-300"
                            onclick="toggleSelection(this, 'dislike')">Crowds</button>
                        <button
                            class="dislike-option p-3 bg-gray-800 hover:bg-red-700 rounded-lg text-sm transition-all duration-300"
                            onclick="toggleSelection(this, 'dislike')">Loud Noises</button>
                        <button
                            class="dislike-option p-3 bg-gray-800 hover:bg-red-700 rounded-lg text-sm transition-all duration-300"
                            onclick="toggleSelection(this, 'dislike')">Spicy Food</button>
                        <button
                            class="dislike-option p-3 bg-gray-800 hover:bg-red-700 rounded-lg text-sm transition-all duration-300"
                            onclick="toggleSelection(this, 'dislike')">Horror Movies</button>
                        <button
                            class="dislike-option p-3 bg-gray-800 hover:bg-red-700 rounded-lg text-sm transition-all duration-300"
                            onclick="toggleSelection(this, 'dislike')">Early Mornings</button>
                        <button
                            class="dislike-option p-3 bg-gray-800 hover:bg-red-700 rounded-lg text-sm transition-all duration-300"
                            onclick="toggleSelection(this, 'dislike')">Public Speaking</button>
                        <button
                            class="dislike-option p-3 bg-gray-800 hover:bg-red-700 rounded-lg text-sm transition-all duration-300"
                            onclick="toggleSelection(this, 'dislike')">Waiting</button>
                        <button
                            class="dislike-option p-3 bg-gray-800 hover:bg-red-700 rounded-lg text-sm transition-all duration-300"
                            onclick="toggleSelection(this, 'dislike')">Clutter</button>
                    </div>

                    <textarea id="custom-dislikes" placeholder="Or write your own dislikes here..."
                        class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500 text-white resize-none"
                        rows="3"></textarea>
                </div>

                <div class="text-center">
                    <div class="space-y-4 text-center">
                        <button id="continue-preferences"
                            class="px-8 py-3 bg-gradient-to-r from-purple-600 to-blue-500 rounded-full font-medium text-lg hover:opacity-90 transition-all duration-300">
                            Continue Your Journey
                        </button>
                        <p class="mt-3 text-sm text-gray-400">
                            <span id="skip-preferences"
                                class="cursor-pointer underline hover:text-white transition-colors">
                                You can skip this step if you prefer
                            </span>
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="stage-3" class="min-h-screen hidden flex-col items-center justify-center p-6">
        <h1 class="text-4xl font-bold mb-4 text-center" data-aos="fade-down">Chamber of Choices</h1>
        <p class="text-xl text-gray-300 mb-12 max-w-lg text-center" data-aos="fade-up">Select what calls to you</p>

        <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-6 max-w-6xl" id="interest-container"
            data-aos="zoom-in">
        </div>

        <div id="continue-btn" class="mt-12 hidden" data-aos="fade-up">
            <button
                class="px-8 py-3 bg-gradient-to-r from-purple-600 to-blue-500 rounded-full font-medium text-lg hover:opacity-90 transition-all duration-300">
                Continue Your Journey
            </button>
        </div>
    </div>
    <div id="stage-4" class="min-h-screen hidden flex items-center justify-center p-6">
        <div class="gateway-form p-10 max-w-2xl w-full text-center" data-aos="zoom-in">
            <div class="h-32 mb-8 flex items-center justify-center">
                <i data-feather="compass" class="w-16 h-16 text-yellow-400"></i>
            </div>
            <h1 class="text-4xl font-bold mb-4">Every adventurer has a story</h1>
            <p class="text-xl text-gray-300 mb-12">"Where are you on your path?"</p>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4" data-aos="fade-up">
                <button onclick="selectContext('school')"
                    class="p-6 bg-gray-800 hover:bg-gray-700 rounded-xl transition-all duration-300 text-left">
                    <h3 class="text-xl font-semibold">In School</h3>
                    <p class="mt-2 text-gray-400">Still learning the basics</p>
                </button>
                <button onclick="selectContext('college')"
                    class="p-6 bg-gray-800 hover:bg-gray-700 rounded-xl transition-all duration-300 text-left">
                    <h3 class="text-xl font-semibold">In College/University</h3>
                    <p class="mt-2 text-gray-400">Expanding my knowledge</p>
                </button>
                <button onclick="selectContext('professional')"
                    class="p-6 bg-gray-800 hover:bg-gray-700 rounded-xl transition-all duration-300 text-left">
                    <h3 class="text-xl font-semibold">A Working Professional</h3>
                    <p class="mt-2 text-gray-400">Applying my skills daily</p>
                </button>
                <button onclick="selectContext('exploring')"
                    class="p-6 bg-gray-800 hover:bg-gray-700 rounded-xl transition-all duration-300 text-left">
                    <h3 class="text-xl font-semibold">Just Exploring</h3>
                    <p class="mt-2 text-gray-400">Curious about possibilities</p>
                </button>
            </div>
        </div>
    </div>
    <div id="stage-5" class="min-h-screen hidden flex items-center justify-center p-6">
        <div class="gateway-form p-10 max-w-5xl w-full text-center" data-aos="zoom-in">
            <div class="mb-8">
                <div
                    class="h-32 w-32 mx-auto mb-6 rounded-full bg-gradient-to-br from-purple-600 to-blue-500 flex items-center justify-center shadow-xl">
                    <i data-feather="user-check" class="w-16 h-16 text-white"></i>
                </div>
                <h1 class="text-4xl font-bold mb-4">Review Your Profile</h1>
                <p class="text-xl text-gray-300">Please confirm your details are correct before we begin</p>
            </div>

            <div class="bg-gray-800 rounded-2xl p-8 mb-8 shadow-2xl" data-aos="fade-up">
                <h3 class="text-2xl font-semibold mb-6 text-center">Your Complete Profile</h3>

                <div class="mb-8 p-6 bg-gray-700 rounded-xl">
                    <h4 class="text-lg font-medium text-yellow-400 mb-4 flex items-center">
                        <i data-feather="user" class="w-5 h-5 mr-2"></i>
                        Personal Information
                    </h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-gray-300">
                        <div>
                            <span class="text-gray-400">Name:</span>
                            <span id="summary-name" class="ml-2 font-medium">Not provided</span>
                        </div>
                        <div>
                            <span class="text-gray-400">Username:</span>
                            <span id="summary-username" class="ml-2 font-medium">Not provided</span>
                        </div>
                        <div>
                            <span class="text-gray-400">Email:</span>
                            <span id="summary-email" class="ml-2 font-medium">Not provided</span>
                        </div>
                        <div>
                            <span class="text-gray-400">Context:</span>
                            <span id="context-display" class="ml-2 font-medium">Not specified</span>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div class="p-6 bg-green-900 bg-opacity-30 rounded-xl border border-green-700">
                        <h4 class="text-lg font-medium text-green-400 mb-4 flex items-center">
                            <i data-feather="heart" class="w-5 h-5 mr-2"></i>
                            Things You Like
                        </h4>
                        <ul class="space-y-2" id="passions-list">
                        </ul>
                    </div>

                    <div class="p-6 bg-red-900 bg-opacity-30 rounded-xl border border-red-700">
                        <h4 class="text-lg font-medium text-red-400 mb-4 flex items-center">
                            <i data-feather="x-circle" class="w-5 h-5 mr-2"></i>
                            Things You Dislike
                        </h4>
                        <ul class="space-y-2" id="dislikes-list">
                        </ul>
                    </div>
                </div>
            </div>

            <div class="space-y-4" data-aos="fade-up">
                <div class="flex flex-col sm:flex-row gap-4 justify-center">
                    <button id="edit-profile-btn"
                        class="px-6 py-3 bg-gray-600 hover:bg-gray-500 rounded-full font-medium text-lg transition-all duration-300">
                        ‚Üê Edit Profile
                    </button>
                    <button id="confirm-profile-btn"
                        class="px-8 py-3 bg-gradient-to-r from-purple-600 to-blue-500 rounded-full font-medium text-lg hover:opacity-90 transition-all duration-300">
                        Looks Good! Continue ‚Üí
                    </button>
                </div>
                <p class="text-sm text-gray-400">You can always update your preferences later</p>
            </div>
        </div>
    </div>

    <div id="quote-page" class="min-h-screen hidden flex items-center justify-center p-6">
        <div class="max-w-4xl w-full text-center" data-aos="fade-in">
            <blockquote class="text-3xl md:text-5xl font-light text-white italic mb-8">
                "Every expert was once a beginner.<br>
                Every pro was once an amateur."
            </blockquote>
            <p class="text-xl text-gray-300">- Your journey starts now!</p>
        </div>
    </div>

    <div id="profile-modal"
        class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center">
        <div class="gateway-form p-10 max-w-5xl w-full text-center relative"
            style="max-height: 90vh; overflow-y: auto;">
            <button onclick="document.getElementById('profile-modal').classList.add('hidden')"
                class="absolute top-4 right-4 text-white hover:text-gray-400">
                <i data-feather="x" class="w-6 h-6"></i>
            </button>
            <h1 class="text-3xl font-bold mb-4">Your Profile Summary</h1>
            <div id="modal-summary-content"></div>
        </div>
    </div>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

    <div id="main-page" class="flex h-screen bg-gray-100 dark:bg-gray-900 transition-colors duration-300 hidden">

        <aside id="sidebar"
            class="w-64 flex-shrink-0 bg-gray-800 dark:bg-gray-900 text-white flex flex-col border-r border-gray-700 transition-transform duration-300 transform -translate-x-full md:translate-x-0">
            <div class="p-4 border-b border-gray-700 flex items-center justify-between">
                <h2 class="text-xl font-bold">VTA Sessions</h2>
                <button id="sidebar-close-btn" class="text-white md:hidden p-1 rounded hover:bg-gray-700">
                    <i data-feather="x" class="w-6 h-6"></i>
                </button>
            </div>

            <div class="p-4">
                <button id="new-session-btn"
                    class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg flex items-center justify-center transition-colors">
                    <i data-feather="plus" class="w-5 h-5 mr-2"></i> New Study Session
                </button>
            </div>

            <nav class="flex-grow overflow-y-auto p-2 space-y-1">
                <div id="session-list" class="space-y-1">
                    <div class="p-3 bg-gray-700 rounded-lg cursor-pointer">
                        <p class="text-sm font-medium truncate">Welcome Session (Active)</p>
                        <span class="text-xs text-gray-400">Oct 8, 2025</span>
                    </div>
                </div>
                <p id="no-sessions" class="text-center text-sm text-gray-500 p-4 hidden">No recent sessions.</p>
            </nav>

            <div id="combined-emotion-panel" class="p-3 bg-gray-900 border-t border-gray-700 space-y-4">

                <div id="emotion-awareness-box"
                    class="p-3 bg-gray-800 rounded-lg shadow-md border border-gray-700 text-center">
                    <h3 class="text-xs font-semibold text-gray-300 mb-2 border-b border-gray-700 pb-1">Facial Emotion
                    </h3>

                    <div id="webcam-placeholder-container"
                        class="h-20 w-20 mx-auto rounded-full bg-gray-700 flex items-center justify-center mb-2">
                        <i data-feather="video-off" class="w-8 h-8 text-gray-500" id="webcam-icon"></i>
                    </div>
                    <video id="webcam-feed" autoplay
                        class="hidden h-20 w-20 mx-auto rounded-full object-cover mb-2"></video>

                    <p id="detected-emotion" class="text-sm font-bold text-green-400">Neutral</p>
                    <button id="start-webcam-btn" class="mt-1 text-xs text-blue-400 hover:underline">Start
                        Webcam</button>
                </div>
            </div>
            <div class="p-4 border-t border-gray-700 text-sm">
                <a href="#" class="block text-gray-400 hover:text-white transition-colors" onclick="logout()">
                    <i data-feather="log-out" class="w-4 h-4 mr-2 inline"></i> Logout
                </a>
            </div>
        </aside>

        <main class="flex flex-col flex-grow relative">
            <header
                class="h-16 flex-shrink-0 bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between px-4 transition-colors duration-300">
                <button id="sidebar-open-btn"
                    class="text-gray-900 dark:text-white md:hidden p-1 rounded hover:bg-gray-200 dark:hover:bg-gray-700">
                    <i data-feather="menu" class="w-6 h-6"></i>
                </button>

                <h1 class="text-xl font-semibold text-gray-900 dark:text-white" id="current-session-title">
                    Welcome to VTA
                </h1>

                <div id="emotion-feedback-container" class="absolute left-1/2 transform -translate-x-1/2">
                    <div id="emotion-feedback-banner"
                        class="text-sm font-medium text-center px-4 py-1 rounded-full text-white hidden">
                        VTA is ready to adapt!
                    </div>
                </div>

                <div class="flex items-center space-x-4">

                    <div class="flex items-center space-x-2">
                        <div id="pomodoro-timer"
                            class="flex items-center space-x-2 p-2 rounded-full bg-yellow-100 dark:bg-yellow-900 text-yellow-800 dark:text-yellow-300 cursor-pointer hover:opacity-80 transition-opacity"
                            title="Click to Start/Pause Timer">
                            <i data-feather="clock" class="w-5 h-5"></i>
                            <span id="timer-display" class="font-bold">25:00</span>
                        </div>
                        <button id="pomodoro-settings-btn"
                            class="p-2 rounded-full bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors"
                            title="Pomodoro Settings">
                            <i data-feather="settings" class="w-5 h-5"></i>
                        </button>
                    </div>

                    <button id="profile-icon" class="flex items-center space-x-2 text-gray-900 dark:text-white">
                        <div
                            class="h-8 w-8 rounded-full bg-gradient-to-r from-purple-600 to-blue-500 flex items-center justify-center">
                            <i data-feather="user" class="w-4 h-4 text-white"></i>
                        </div>
                        <span class="text-sm font-medium hidden sm:inline" id="user-greeting-vta">User</span>
                    </button>
                </div>
            </header>

            <div id="profile-modal"
                class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center">
                <div class="gateway-form p-10 max-w-5xl w-full text-center relative"
                    style="max-height: 90vh; overflow-y: auto;">
                    <button onclick="document.getElementById('profile-modal').classList.add('hidden')"
                        class="absolute top-4 right-4 text-white hover:text-gray-400">
                        <i data-feather="x" class="w-6 h-6"></i>
                    </button>
                    <h1 class="text-3xl font-bold mb-4">Your Profile Summary</h1>
                    <div id="modal-summary-content"></div>
                </div>
            </div>

            <!-- Pomodoro Settings Modal -->
            <div id="pomodoro-settings-modal"
                class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center">
                <div class="gateway-form p-8 max-w-md w-full relative">
                    <button onclick="document.getElementById('pomodoro-settings-modal').classList.add('hidden')"
                        class="absolute top-4 right-4 text-white hover:text-gray-400">
                        <i data-feather="x" class="w-6 h-6"></i>
                    </button>
                    <h2 class="text-2xl font-bold mb-6 text-center">‚è±Ô∏è Pomodoro Settings</h2>

                    <div class="space-y-4">
                        <div>
                            <h3 class="text-lg font-semibold mb-3">Timer Presets</h3>
                            <div class="grid grid-cols-2 gap-3">
                                <button onclick="setPomodoroPreset('classic')"
                                    class="p-4 bg-blue-600 hover:bg-blue-700 rounded-lg transition-colors text-left">
                                    <div class="font-bold">üéØ Classic</div>
                                    <div class="text-sm opacity-90">25 min / 5 min</div>
                                </button>
                                <button onclick="setPomodoroPreset('short')"
                                    class="p-4 bg-green-600 hover:bg-green-700 rounded-lg transition-colors text-left">
                                    <div class="font-bold">‚ö° Short</div>
                                    <div class="text-sm opacity-90">15 min / 3 min</div>
                                </button>
                                <button onclick="setPomodoroPreset('long')"
                                    class="p-4 bg-purple-600 hover:bg-purple-700 rounded-lg transition-colors text-left">
                                    <div class="font-bold">üî• Long</div>
                                    <div class="text-sm opacity-90">50 min / 10 min</div>
                                </button>
                                <button onclick="setPomodoroPreset('custom')"
                                    class="p-4 bg-orange-600 hover:bg-orange-700 rounded-lg transition-colors text-left">
                                    <div class="font-bold">‚öôÔ∏è Custom</div>
                                    <div class="text-sm opacity-90">Set your own</div>
                                </button>
                            </div>
                        </div>

                        <div id="custom-timer-settings" class="hidden space-y-3">
                            <div>
                                <label class="block text-sm font-medium mb-1">Work Duration (minutes)</label>
                                <input type="number" id="custom-work-duration" value="25" min="1" max="120"
                                    class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">Break Duration (minutes)</label>
                                <input type="number" id="custom-break-duration" value="5" min="1" max="30"
                                    class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <button onclick="applyCustomTimer()"
                                class="w-full bg-blue-600 hover:bg-blue-700 py-2 rounded-lg transition-colors">
                                Apply Custom Timer
                            </button>
                        </div>

                        <div class="pt-4 border-t border-gray-700">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm">Auto-start breaks</span>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="auto-start-breaks" class="sr-only peer" checked>
                                    <div
                                        class="w-11 h-6 bg-gray-700 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-800 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600">
                                    </div>
                                </label>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-sm">Sound notifications</span>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="sound-notifications" class="sr-only peer" checked>
                                    <div
                                        class="w-11 h-6 bg-gray-700 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-800 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600">
                                    </div>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="chat-area" class="flex-grow overflow-y-auto p-6 pb-24 space-y-4">
                <div id="messages-container" class="max-w-4xl mx-auto">
                    <div class="flex justify-start">
                        <div class="bg-blue-100 dark:bg-blue-800 p-3 rounded-xl max-w-lg text-sm shadow">
                            <p class="text-blue-900 dark:text-blue-100 font-medium">Welcome! I'm your Emotion-Aware VTA.
                                How can I help you learn today?</p>
                        </div>
                    </div>
                </div>
            </div>

            <div
                class="absolute bottom-0 left-0 right-0 p-4 bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700">
                <div class="max-w-4xl mx-auto flex items-center space-x-3">

                    <!-- Microphone button removed as per user request -->

                    <input type="text" id="user-input" placeholder="Ask VTA a question or type your prompt..."
                        class="flex-grow px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white"
                        autofocus>

                    <button id="send-message-btn"
                        class="p-3 rounded-full bg-blue-500 hover:bg-blue-600 text-white transition-colors duration-200 shadow-md">
                        <i data-feather="send" class="w-6 h-6"></i>
                    </button>
                </div>
            </div>
        </main>
    </div>
    </footer>
    </div>

    <script>
        // Text-to-Speech (TTS) Function
        function speakText(text) {
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(text);

                utterance.rate = 1.0;
                utterance.pitch = 1.0;

                const voices = window.speechSynthesis.getVoices();
                const preferredVoice = voices.find(v => v.lang.startsWith('en-') && v.default);
                if (preferredVoice) {
                    utterance.voice = preferredVoice;
                }

                window.speechSynthesis.speak(utterance);
            } else {
                console.error("Web Speech API (Text-to-Speech) not supported in this browser.");
            }
        }

        // Function to Render Markdown and add the TTS Button
        function renderVtaContent(vtaElement, rawMarkdown) {
            const messageBox = vtaElement.querySelector('.bg-blue-100, .dark\\:bg-blue-800');
            const contentDiv = vtaElement.querySelector('.vta-text-content');

            if (!messageBox || !contentDiv) return;

            contentDiv.innerHTML = marked.parse(rawMarkdown);
            const wrapper = document.createElement('div');
            wrapper.className = 'flex items-start justify-between';
            const textContainer = document.createElement('div');
            textContainer.innerHTML = contentDiv.innerHTML;
            textContainer.className = 'flex-grow';
            const speechText = rawMarkdown.replace(/[\*\#\n]/g, ' ').trim();
            const ttsButton = document.createElement('button');
            ttsButton.className = 'tts-button flex-shrink-0';
            ttsButton.innerHTML = '<i class="fas fa-volume-up"></i>';
            ttsButton.title = 'Speak Response';
            ttsButton.onclick = function () {
                speakText(speechText);
            };
            wrapper.appendChild(textContainer);
            wrapper.appendChild(ttsButton);
            contentDiv.innerHTML = '';
            contentDiv.appendChild(wrapper);
        }

        // Initialize animations and effects
        AOS.init({
            duration: 800,
            easing: 'ease-in-out',
            once: true
        });
        const API_BASE = 'http://127.0.0.1:5000/api';
        let currentConversationId = null;
        let currentEmotion = "Neutral";
        let sessionTopicSet = false;  // Track if topic has been set for current session
        let socket;
        let mediaRecorder;
        function initializeStaticGlobe() {
            try {
                VANTA.GLOBE({
                    el: "#static-globe",
                    mouseControls: false,
                    touchControls: false,
                    gyroControls: false,
                    minHeight: 200.00,
                    minWidth: 200.00,
                    scale: 1.00,
                    scaleMobile: 1.00,
                    color: 0x3f3f6f,
                    backgroundColor: 0x111827,
                    size: 0.8,
                    speed: 0
                });
            } catch (error) {
                console.log('Static globe initialization skipped');
            }
        }

        function initializeLoadingGlobe() {
            try {
                VANTA.GLOBE({
                    el: "#loading-globe",
                    mouseControls: true,
                    touchControls: true,
                    gyroControls: false,
                    minHeight: 200.00,
                    minWidth: 200.00,
                    scale: 1.00,
                    scaleMobile: 1.00,
                    color: 0x3f3f6f,
                    backgroundColor: 0x111827,
                    size: 0.8,
                    speed: 1.5
                });
            } catch (error) {
                console.log('Loading globe initialization skipped');
            }
        }

        window.onload = function () {
            AOS.init({ duration: 800, easing: 'ease-in-out', once: true });
            feather.replace();

            VANTA.GLOBE({
                el: "#vanta-bg",
                mouseControls: true,
                touchControls: true,
                gyroControls: false,
                minHeight: 200.00,
                minWidth: 200.00,
                scale: 1.00,
                scaleMobile: 1.00,
                color: 0x3f3f6f,
                backgroundColor: 0x111827,
                size: 0.8
            });

            checkLoginStatus();

            document.getElementById('show-signup')?.addEventListener('click', function () {
                document.getElementById('stage-1').classList.add('hidden');
                document.getElementById('signup-page').classList.remove('hidden');
            });

            document.getElementById('back-to-login')?.addEventListener('click', function () {
                document.getElementById('signup-page').classList.add('hidden');
                document.getElementById('stage-1').classList.remove('hidden');
            });

        };

        const interests = [
            "Fantasy Novels", "Coding", "Hiking", "Action Movies",
            "Photography", "Cooking", "Music", "Travel",
            "Gaming", "Yoga", "Art", "Science"
        ];

        // Stage 1: Login
        document.getElementById('login-btn').addEventListener('click', function () {
            const identifier = document.querySelector('input[type="email"]').value;
            const password = document.querySelector('input[type="password"]').value;

            fetch('http://127.0.0.1:5000/login', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                credentials: 'include',  // Include cookies
                body: JSON.stringify({ identifier, password }),
            })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => { throw new Error(err.message); });
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        console.log('Login successful:', data);
                        // Instead of reloading, directly show the main page
                        document.getElementById('stage-1').classList.add('hidden');
                        document.getElementById('main-page').classList.remove('hidden');

                        // Fetch username and initialize VTA
                        fetch('http://127.0.0.1:5000/check_session', {
                            credentials: 'include'  // Include cookies
                        })
                            .then(response => response.json())
                            .then(sessionData => {
                                if (sessionData.is_authenticated) {
                                    document.getElementById('user-greeting-vta').textContent = sessionData.username || 'Learner';
                                }
                                initializeVTA();
                            })
                            .catch(err => {
                                console.error('Error fetching session:', err);
                                initializeVTA(); // Initialize anyway
                            });
                    } else {
                        alert(data.message);
                    }
                })
                .catch(error => {
                    console.error('Login failed:', error);
                    alert(error.message);
                });
        });

        // Signup page
        document.getElementById('show-signup').addEventListener('click', function () {
            document.getElementById('stage-1').classList.add('hidden');
            document.getElementById('signup-page').classList.remove('hidden');
        });

        // Back to login from signup
        document.getElementById('back-to-login').addEventListener('click', function () {
            document.getElementById('signup-page').classList.add('hidden');
            document.getElementById('stage-1').classList.remove('hidden');
        });

        // Signup validation with specific email domain and direct transition
        document.getElementById('signup-btn').addEventListener('click', function (e) {
            e.preventDefault();

            const name = document.getElementById('signup-name').value.trim();
            const username = document.getElementById('signup-username').value.trim();
            const email = document.getElementById('signup-email').value.trim();
            const password = document.getElementById('signup-password').value.trim();
            const repeat = document.getElementById('signup-repeat').value.trim();

            // 1. Client-Side Validation
            if (!name || !username || !email || !password || !repeat) {
                alert("Please fill out all fields before proceeding.");
                return;
            }

            const emailPattern = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
            if (!emailPattern.test(email)) {
                alert("Invalid email format. Please enter a valid email address (example@email.com)");
                return;
            }
            if (password.length < 8) {
                alert("Password must be at least 8 characters long.");
                return;
            }
            if (password !== repeat) {
                alert("Passwords do not match. Please check again.");
                return;
            }

            // 2. Server-Side Request (API Call)
            fetch('http://127.0.0.1:5000/signup', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    name: name,
                    username: username,
                    email: email,
                    password: password,
                    confirm_password: repeat
                }),
            })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => { throw new Error(err.message); });
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Signup successful:', data);
                    if (data.success) {
                        // Store user data for profile summary
                        window.userData = {
                            name: name,
                            username: username,
                            email: email
                        };

                        document.getElementById('signup-page').classList.add('hidden');
                        document.getElementById('stage-2').classList.remove('hidden');
                        document.getElementById('stage-2').classList.add('slide-up');
                    }
                    else {
                        alert(data.message);
                    }
                })
                .catch(error => {
                    console.error('Signup failed:', error);
                    alert(error.message);
                });
        });
        // Add Enter key support for signup form
        document.getElementById('signup-form').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                document.getElementById('signup-btn').click();
            }
        });

        // Stage 2: Likes and Dislikes Selection
        function toggleSelection(button, type) {
            button.classList.toggle('selected');
            if (type === 'like') {
                button.classList.toggle('bg-green-700');
            } else {
                button.classList.toggle('bg-red-700');
            }
        }

        // to handle the "skip" action
        document.getElementById('skip-preferences').addEventListener('click', function () {
            console.log('User chose to skip preferences.');
            document.getElementById('stage-2').classList.add('hidden');
            document.getElementById('stage-4').classList.remove('hidden');
        });

        // for the "Continue Your Journey" button
        document.getElementById('continue-preferences').addEventListener('click', function () {
            const selectedLikes = [];
            const selectedDislikes = [];

            document.querySelectorAll('.like-option.selected').forEach(btn => {
                selectedLikes.push(btn.textContent);
            });

            document.querySelectorAll('.dislike-option.selected').forEach(btn => {
                selectedDislikes.push(btn.textContent);
            });

            const customLikes = document.getElementById('custom-likes').value.trim();
            const customDislikes = document.getElementById('custom-dislikes').value.trim();

            if (customLikes) selectedLikes.push(customLikes);
            if (customDislikes) selectedDislikes.push(customDislikes);

            const preferencesData = {
                likes: selectedLikes,
                dislikes: selectedDislikes
            };

            // Make API call to store data
            fetch('http://127.0.0.1:5000/api/profile', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(preferencesData),
            })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => { throw new Error(err.message); });
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Preferences updated successfully:', data);
                    window.userPreferences = preferencesData;
                    if (data.success) {
                        document.getElementById('stage-2').classList.add('hidden');
                        document.getElementById('stage-4').classList.remove('hidden');
                    } else {
                        alert('Failed to save preferences: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Failed to save preferences:', error);
                    alert('Failed to save preferences. Please try again.');
                });
        });
        // Stage 4: Context Selection
        function selectContext(context) {
            window.userContext = context;
            const userPreferences = window.userPreferences || { likes: [], dislikes: [] };
            const profileData = {
                likes: userPreferences.likes,
                dislikes: userPreferences.dislikes,
                context: window.userContext
            };

            fetch('http://127.0.0.1:5000/api/profile', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(profileData),
            })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => { throw new Error(err.message); });
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Profile context updated:', data);
                    if (data.success) {
                        document.getElementById('stage-4').classList.add('hidden');
                        document.getElementById('stage-5').classList.remove('hidden');
                        populateProfileSummary();
                    } else {
                        alert('Failed to save profile context: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Failed to save context:', error);
                    alert('Failed to save your profile context. Please try again.');
                });
        }
        // Function to populate the profile summary
        function populateProfileSummary() {
            const name = window.userData?.name || document.getElementById('summary-name').textContent || 'Not provided';
            const username = window.userData?.username || document.getElementById('summary-username').textContent || 'Not provided';
            const email = window.userData?.email || document.getElementById('summary-email').textContent || 'Not provided';

            document.getElementById('summary-name').textContent = name;
            document.getElementById('summary-username').textContent = username;
            document.getElementById('summary-email').textContent = email;

            const contextDisplay = document.getElementById('context-display');
            switch (window.userContext) {
                case 'school': contextDisplay.textContent = "In School - Still learning the basics"; break;
                case 'college': contextDisplay.textContent = "In College/University - Expanding my knowledge"; break;
                case 'professional': contextDisplay.textContent = "A Working Professional - Applying my skills daily"; break;
                case 'exploring': contextDisplay.textContent = "Just Exploring - Curious about possibilities"; break;
                default: contextDisplay.textContent = "Not specified"; break;
            }

            const passionsList = document.getElementById('passions-list');
            passionsList.innerHTML = '';

            if (window.userPreferences && window.userPreferences.likes.length > 0) {
                window.userPreferences.likes.forEach(like => {
                    const li = document.createElement('li');
                    li.className = 'flex items-center text-gray-300';
                    li.innerHTML = `<i data-feather="heart" class="w-4 h-4 mr-2 text-green-400"></i> ${like}`;
                    passionsList.appendChild(li);
                });
            } else {
                const li = document.createElement('li');
                li.className = 'flex items-center text-gray-400';
                li.innerHTML = `<i data-feather="minus" class="w-4 h-4 mr-2"></i> No preferences specified`;
                passionsList.appendChild(li);
            }

            const dislikesList = document.getElementById('dislikes-list');
            dislikesList.innerHTML = '';

            if (window.userPreferences && window.userPreferences.dislikes.length > 0) {
                window.userPreferences.dislikes.forEach(dislike => {
                    const li = document.createElement('li');
                    li.className = 'flex items-center text-gray-300';
                    li.innerHTML = `<i data-feather="x-circle" class="w-4 h-4 mr-2 text-red-400"></i> ${dislike}`;
                    dislikesList.appendChild(li);
                });
            } else {
                const li = document.createElement('li');
                li.className = 'flex items-center text-gray-400';
                li.innerHTML = `<i data-feather="minus" class="w-4 h-4 mr-2"></i> No dislikes specified`;
                dislikesList.appendChild(li);
            }

            feather.replace();
        }

        // Edit Profile Button
        document.getElementById('edit-profile-btn').addEventListener('click', function () {
            // Pre-populate the signup form with existing data
            if (window.userData) {
                document.getElementById('signup-name').value = window.userData.name || '';
                document.getElementById('signup-username').value = window.userData.username || '';
                document.getElementById('signup-email').value = window.userData.email || '';
            }

            document.getElementById('stage-5').classList.add('hidden');
            document.getElementById('signup-page').classList.remove('hidden');
        });

        // Confirm Profile Button
        document.getElementById('confirm-profile-btn')?.addEventListener('click', function () {
            document.getElementById('stage-5').classList.add('hidden');
            document.getElementById('quote-page').classList.remove('hidden');

            setTimeout(() => {
                document.getElementById('quote-page').classList.add('hidden');
                document.getElementById('main-page').classList.remove('hidden');

                initializeVTA();
            }, 3000);
        });

        // to check the login status
        function checkLoginStatus() {
            console.log('Checking login status...');
            fetch('http://127.0.0.1:5000/check_session', {
                credentials: 'include'  // Include cookies
            })
                .then(response => {
                    console.log('Check session response status:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('Check session data:', data);
                    if (data.is_authenticated) {
                        console.log('User is authenticated, showing main page');
                        // User is logged in. Hide login stages and show main page.
                        document.getElementById('stage-1').classList.add('hidden');
                        document.getElementById('main-page').classList.remove('hidden');

                        const userName = data.username || 'Learner';
                        document.getElementById('user-greeting-vta').textContent = userName;
                        initializeVTA();
                    } else {
                        console.log('User is not authenticated, showing login page');
                        document.getElementById('stage-1').classList.remove('hidden');
                    }
                })
                .catch(error => {
                    console.error('Error checking session:', error);
                    document.getElementById('stage-1').classList.remove('hidden');
                });
        }
        // ---------------------------------------------

        function initializeVTA() {
            initializeSocketIO();
            feather.replace();
            console.log('VTA initialized successfully');
        }
        // Simulate loading with moving globe
        function simulateLoading() {
            document.getElementById('static-globe').classList.add('hidden');
            document.getElementById('loading-globe').classList.remove('hidden');

            // Initialize moving globe
            initializeLoadingGlobe();

            // Simulate loading for 3 seconds
            setTimeout(() => {
                // Hide loading globe, show static globe
                document.getElementById('loading-globe').classList.add('hidden');
                document.getElementById('static-globe').classList.remove('hidden');

                // Reinitialize static globe
                initializeStaticGlobe();

                alert('Loading complete! This is where your learning content would appear.');
            }, 3000);
        }

        function get_api_endpoint(path) {
            return `http://127.0.0.1:5000${path}`;
        }

        async function fetch_data(path, method = 'GET', body = null) {
            const options = {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                },
                credentials: 'include'  // Include cookies in requests
            };
            if (body) {
                options.body = JSON.stringify(body);
            }
            const url = get_api_endpoint(path);
            const response = await fetch(url, options);

            if (!response.ok) {
                let error_message = `HTTP Error: ${response.status} ${response.statusText} for ${url}`;
                try {
                    const error_data = await response.json();
                    // Prioritize Flask's custom error message if available
                    error_message = error_data.message || error_message;
                } catch (e) {
                    // If the response isn't JSON (e.g., 404 HTML page), we ignore the content
                    console.error(`Failed to parse error response for ${url}. Received HTML/Text.`);
                }

                // Throw an error that will be caught by the calling function's .catch() block
                throw new Error(error_message);
            }

            // Attempt to return JSON for successful response (status 200-299)
            try {
                return response.json();
            } catch (e) {
                // Handle cases where a successful response (like a PUT) has no body (HTTP 204 No Content)
                if (response.status === 204) {
                    return { success: true, message: "No content returned." };
                }
                console.warn(`Response received for ${url}, but body was empty or not strictly JSON.`);
                return { success: true, message: "Response body was not JSON/empty. Assuming success." };
            }
        }

        // Logout
        function logout() {
            fetch('http://127.0.0.1:5000/logout')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Clear state and redirect to force session check
                        window.location.href = "/";
                    } else {
                        alert('Logout failed.');
                    }
                })
                .catch(error => console.error('Logout error:', error));
        }

        // --- ENHANCED POMODORO TIMER ---
        let totalSeconds = 25 * 60;
        let workDuration = 25 * 60;
        let breakDuration = 5 * 60;
        let timerInterval;
        let isTimerRunning = false;
        let currentMode = 'work'; // 'work' or 'break'
        let pomodoroCount = 0;

        function updateTimerDisplay() {
            const minutes = String(Math.floor(totalSeconds / 60)).padStart(2, '0');
            const seconds = String(totalSeconds % 60).padStart(2, '0');
            const timerDisplay = document.getElementById('timer-display');
            if (timerDisplay) {
                timerDisplay.textContent = `${minutes}:${seconds}`;
                // Update the browser tab title for better focus tracking
                const modeEmoji = currentMode === 'work' ? 'üéØ' : '‚òï';
                document.title = `${modeEmoji} ${minutes}:${seconds} | VTA`;
            }
        }

        function notifyUser(title, body) {
            if (!("Notification" in window)) {
                alert(title + " - " + body);
            } else if (Notification.permission === "granted") {
                new Notification(title, { body: body, icon: "https://i.imgur.com/B948u3o.png" });

                // Play sound if enabled
                if (document.getElementById('sound-notifications')?.checked) {
                    playNotificationSound();
                }
            } else if (Notification.permission !== "denied") {
                Notification.requestPermission().then(permission => {
                    if (permission === "granted") {
                        new Notification(title, { body: body, icon: "https://i.imgur.com/B948u3o.png" });
                    }
                });
            }
        }

        function playNotificationSound() {
            // Create a simple beep sound using Web Audio API
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            oscillator.frequency.value = 800;
            oscillator.type = 'sine';

            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);

            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.5);
        }

        function switchMode() {
            const timerDisplay = document.getElementById('timer-display');
            const timerContainer = document.getElementById('pomodoro-timer');

            if (currentMode === 'work') {
                currentMode = 'break';
                pomodoroCount++;
                totalSeconds = breakDuration;

                // Update colors for break mode
                timerContainer.classList.remove('bg-yellow-100', 'dark:bg-yellow-900', 'text-yellow-800', 'dark:text-yellow-300');
                timerContainer.classList.remove('bg-green-100', 'dark:bg-green-900', 'text-green-800', 'dark:text-green-300');
                timerContainer.classList.add('bg-blue-100', 'dark:bg-blue-900', 'text-blue-800', 'dark:text-blue-300');

                notifyUser("Time for a Break! ‚òï", `Great work! Take a ${Math.floor(breakDuration / 60)}-minute break.`);

                // Auto-start break if enabled
                if (document.getElementById('auto-start-breaks')?.checked) {
                    setTimeout(() => startPomodoro(), 2000);
                }
            } else {
                currentMode = 'work';
                totalSeconds = workDuration;

                // Update colors for work mode
                timerContainer.classList.remove('bg-yellow-100', 'dark:bg-yellow-900', 'text-yellow-800', 'dark:text-yellow-300');
                timerContainer.classList.remove('bg-blue-100', 'dark:bg-blue-900', 'text-blue-800', 'dark:text-blue-300');
                timerContainer.classList.add('bg-green-100', 'dark:bg-green-900', 'text-green-800', 'dark:text-green-300');

                notifyUser("Break is Over! üéØ", `Time to focus for ${Math.floor(workDuration / 60)} minutes.`);

                // Auto-start work if enabled
                if (document.getElementById('auto-start-breaks')?.checked) {
                    setTimeout(() => startPomodoro(), 2000);
                }
            }
            updateTimerDisplay();
        }

        function startPomodoro() {
            const timerContainer = document.getElementById('pomodoro-timer');

            if (isTimerRunning) {
                // Pause timer
                clearInterval(timerInterval);
                isTimerRunning = false;
                timerContainer.classList.remove('bg-green-100', 'dark:bg-green-900', 'text-green-800', 'dark:text-green-300');
                timerContainer.classList.remove('bg-blue-100', 'dark:bg-blue-900', 'text-blue-800', 'dark:text-blue-300');
                timerContainer.classList.add('bg-yellow-100', 'dark:bg-yellow-900', 'text-yellow-800', 'dark:text-yellow-300');
                return;
            }

            isTimerRunning = true;
            timerInterval = setInterval(() => {
                totalSeconds--;
                updateTimerDisplay();

                if (totalSeconds <= 0) {
                    clearInterval(timerInterval);
                    isTimerRunning = false;
                    switchMode();
                }
            }, 1000);

            // Update colors based on mode
            if (currentMode === 'work') {
                timerContainer.classList.remove('bg-yellow-100', 'dark:bg-yellow-900', 'text-yellow-800', 'dark:text-yellow-300');
                timerContainer.classList.remove('bg-blue-100', 'dark:bg-blue-900', 'text-blue-800', 'dark:text-blue-300');
                timerContainer.classList.add('bg-green-100', 'dark:bg-green-900', 'text-green-800', 'dark:text-green-300');
            } else {
                timerContainer.classList.remove('bg-yellow-100', 'dark:bg-yellow-900', 'text-yellow-800', 'dark:text-yellow-300');
                timerContainer.classList.remove('bg-green-100', 'dark:bg-green-900', 'text-green-800', 'dark:text-green-300');
                timerContainer.classList.add('bg-blue-100', 'dark:bg-blue-900', 'text-blue-800', 'dark:text-blue-300');
            }
        }

        function setPomodoroPreset(preset) {
            // Stop current timer if running
            if (isTimerRunning) {
                clearInterval(timerInterval);
                isTimerRunning = false;
            }

            currentMode = 'work';
            const customSettings = document.getElementById('custom-timer-settings');

            switch (preset) {
                case 'classic':
                    workDuration = 25 * 60;
                    breakDuration = 5 * 60;
                    customSettings.classList.add('hidden');
                    break;
                case 'short':
                    workDuration = 15 * 60;
                    breakDuration = 3 * 60;
                    customSettings.classList.add('hidden');
                    break;
                case 'long':
                    workDuration = 50 * 60;
                    breakDuration = 10 * 60;
                    customSettings.classList.add('hidden');
                    break;
                case 'custom':
                    customSettings.classList.remove('hidden');
                    return; // Don't apply yet, wait for user input
            }

            totalSeconds = workDuration;
            updateTimerDisplay();
            document.getElementById('pomodoro-settings-modal').classList.add('hidden');
        }

        function applyCustomTimer() {
            const workMins = parseInt(document.getElementById('custom-work-duration').value) || 25;
            const breakMins = parseInt(document.getElementById('custom-break-duration').value) || 5;

            workDuration = workMins * 60;
            breakDuration = breakMins * 60;
            totalSeconds = workDuration;
            currentMode = 'work';

            updateTimerDisplay();
            document.getElementById('pomodoro-settings-modal').classList.add('hidden');
        }

        // Event listeners
        document.getElementById('pomodoro-timer').addEventListener('click', startPomodoro);
        document.getElementById('pomodoro-settings-btn')?.addEventListener('click', function () {
            document.getElementById('pomodoro-settings-modal').classList.remove('hidden');
            feather.replace(); // Re-render feather icons in modal
        });

        if ("Notification" in window) {
            Notification.requestPermission();
        }
        // --- CHAT & SESSION MANAGEMENT ---

        function createMessageElement(sender, content, emotion = null) {
            const isVTA = sender === 'vta';
            const align = isVTA ? 'justify-start' : 'justify-end';
            const bgColor = isVTA ? 'bg-blue-100 dark:bg-blue-800' : 'bg-green-100 dark:bg-green-700';
            const textColor = isVTA ? 'text-blue-900 dark:text-blue-100' : 'text-green-900 dark:text-green-100';

            const messageDiv = document.createElement('div');
            messageDiv.className = `flex ${align} mb-4`;

            let contentHTML = `
                <div class="${bgColor} p-3 rounded-xl max-w-lg text-sm shadow">
                    <div class="${textColor} vta-text-content">${content}</div>
                    ${emotion ? `<p class="text-xs mt-1 italic text-gray-500 dark:text-gray-400">Emotion: ${emotion}</p>` : ''}
                </div>
            `;

            if (!isVTA) {
                contentHTML = `
                    <div class="${bgColor} p-3 rounded-xl max-w-lg text-sm shadow">
                        <p class="${textColor}">${content}</p>
                        ${emotion ? `<p class="text-xs mt-1 italic text-gray-500 dark:text-gray-400">Emotion: ${emotion}</p>` : ''}
                    </div>
                `;
            }

            messageDiv.innerHTML = contentHTML;
            return messageDiv;
        }

        function scrollToBottom() {
            const chatArea = document.getElementById('chat-area');
            chatArea.scrollTop = chatArea.scrollHeight;
        }

        async function loadSessionMessages(sessionId) {
            const container = document.getElementById('messages-container');
            container.innerHTML = '';
            currentConversationId = sessionId;

            const data = await fetch_data(`/api/sessions/${sessionId}/messages`);
            if (data.success) {
                document.getElementById('current-session-title').textContent = data.title;
                sessionTopicSet = data.topic_set || false;  // Update topic state
                data.messages.forEach(msg => {
                    const el = createMessageElement(msg.sender, msg.content, msg.emotion);
                    container.appendChild(el);
                    if (msg.sender === 'vta') {
                        renderVtaContent(el, msg.content);
                    }
                });
                scrollToBottom();
            } else {
                console.error('Failed to load session:', data.message);
            }
        }

        async function loadUserProfileData() {
            try {
                const data = await fetch_data('/api/profile', 'GET');
                if (data.success) {
                    // 1. Store complete user data globally for use by profile modal
                    window.userData = {
                        name: data.name,
                        username: data.username,
                        email: data.email
                    };

                    // 2. Store preferences and context separately
                    window.userPreferences = {
                        likes: data.likes,
                        dislikes: data.dislikes
                    };
                    window.userContext = data.context;

                    // 3. Populate the summary modal data fields immediately
                    document.getElementById('summary-name').textContent = data.name;
                    document.getElementById('summary-username').textContent = data.username;
                    document.getElementById('summary-email').textContent = data.email;

                } else {
                    console.warn("Failed to retrieve profile preferences:", data.message);
                }
            } catch (error) {
                console.error("Error fetching profile data:", error);
            }
        }

        async function fetchRecentSessions() {
            const list = document.getElementById('session-list');
            const noSessions = document.getElementById('no-sessions');
            list.innerHTML = '';

            const data = await fetch_data('/api/sessions');
            if (data.success && data.sessions.length > 0) {
                noSessions.classList.add('hidden');
                data.sessions.forEach(session => {
                    const item = document.createElement('div');
                    item.className = 'p-3 hover:bg-gray-700 rounded-lg cursor-pointer transition-colors';
                    item.setAttribute('data-session-id', session.id);
                    item.innerHTML = `
                        <p class="text-sm font-medium truncate">${session.title}</p>
                        <span class="text-xs text-gray-400">${session.created_at}</span>
                    `;
                    item.addEventListener('click', () => loadSessionMessages(session.id));
                    list.appendChild(item);
                });
                if (data.sessions[0].id && !currentConversationId) {
                    loadSessionMessages(data.sessions[0].id);
                }
            } else {
                noSessions.classList.remove('hidden');
                if (!currentConversationId) {
                    await startNewSession();
                }
            }
        }

        async function startNewSession() {
            // Create new session without prompting for name
            const data = await fetch_data('/api/sessions/new', 'POST', {});
            if (data.success) {
                currentConversationId = data.conversation_id;
                sessionTopicSet = false;  // Reset topic flag for new session
                document.getElementById('messages-container').innerHTML = '';

                // Display combined welcome message
                const welcomeEl = createMessageElement('vta', data.welcome_message);
                document.getElementById('messages-container').appendChild(welcomeEl);
                renderVtaContent(welcomeEl, data.welcome_message);

                document.getElementById('current-session-title').textContent = data.title;
                fetchRecentSessions();
                scrollToBottom();
            } else {
                alert('Failed to start new session: ' + data.message);
            }
        }

        async function sendMessage(message) {
            if (!message.trim() || !currentConversationId) return;

            const inputField = document.getElementById('user-input');
            inputField.value = '';

            // Display user message immediately
            const userEl = createMessageElement('user', message, currentEmotion);
            document.getElementById('messages-container').appendChild(userEl);
            scrollToBottom();

            const loadingEl = createMessageElement('vta', '...');
            loadingEl.id = 'vta-loading-indicator';
            document.getElementById('messages-container').appendChild(loadingEl);
            scrollToBottom();

            // Check if this is the first message (topic setting)
            if (!sessionTopicSet) {
                // Set the session topic
                const topicData = await fetch_data(`/api/sessions/${currentConversationId}/set-topic`, 'POST', {
                    topic: message
                });

                document.getElementById('vta-loading-indicator')?.remove();

                if (topicData.success) {
                    sessionTopicSet = true;
                    document.getElementById('current-session-title').textContent = topicData.title;

                    // Display acknowledgment
                    const ackEl = createMessageElement('vta', topicData.acknowledgment);
                    document.getElementById('messages-container').appendChild(ackEl);
                    renderVtaContent(ackEl, topicData.acknowledgment);
                    scrollToBottom();
                    fetchRecentSessions();
                } else {
                    alert('Failed to set topic: ' + topicData.message);
                }
                return;
            }

            // Normal chat message
            const data = await fetch_data('/api/chat', 'POST', {
                message: message,
                conversation_id: currentConversationId,
                emotion_detected: currentEmotion
            });

            document.getElementById('vta-loading-indicator')?.remove();
            if (data.success) {
                const vtaMessage = data.vta_response;
                const vtaEl = createMessageElement('vta', vtaMessage, 'VTA');
                document.getElementById('messages-container').appendChild(vtaEl);

                const contentDiv = vtaEl.querySelector('.vta-text-content');
                contentDiv.textContent = '';

                let charIndex = 0;
                const typingInterval = setInterval(() => {
                    if (charIndex < vtaMessage.length) {
                        contentDiv.textContent += vtaMessage.charAt(charIndex);
                        charIndex++;
                        scrollToBottom();
                    } else {
                        clearInterval(typingInterval);
                        renderVtaContent(vtaEl, vtaMessage);
                        scrollToBottom();
                    }
                }, 15);
            } else {
                alert('VTA Error: ' + data.message);
            }
        }

        // --- REAL-TIME MEDIA & SOCKET.IO ---

        function initializeSocketIO() {
            socket = io.connect('http://127.0.0.1:5000');

            socket.on('connect', () => {
                console.log('Socket.IO Connected!');
            });

            // Listener for emotion updates from the backend
            socket.on('video_response', (data) => {
                const emotion = data.emotion || "Undetected";
                document.getElementById('detected-emotion').textContent = emotion;
                currentEmotion = emotion;

                // Feedback Banner
                const banner = document.getElementById('emotion-feedback-banner');
                let message = `VTA detects you are **${emotion.toUpperCase()}**! Keep focused.`;
                let color = 'bg-blue-600';

                if (emotion === 'Angry' || emotion === 'Frustrated' || emotion === 'Disgust') {
                    message = `Take a break! You seem **${emotion.toUpperCase()}**.`;
                    color = 'bg-red-600';
                } else if (emotion === 'Happy' || emotion === 'Excited') {
                    message = `That's great! You seem **${emotion.toUpperCase()}**. Let's keep this energy!`;
                    color = 'bg-green-600';
                } else if (emotion === 'Boredom') {
                    message = `I see **BOREDOM**. Let's try a different teaching style.`;
                    color = 'bg-yellow-600';
                }

                banner.textContent = message.replace(/\*\*/g, '');
                banner.className = `text-sm font-medium text-center px-4 py-1 rounded-full text-white ${color}`;
                banner.classList.remove('hidden');
            });
        }

        async function startWebcamStream() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                const videoElement = document.getElementById('webcam-feed');
                const placeholderContainer = document.getElementById('webcam-placeholder-container');

                videoElement.srcObject = stream;
                videoElement.classList.remove('hidden');
                placeholderContainer.classList.add('hidden');
                document.getElementById('start-webcam-btn').textContent = 'Streaming...';
                videoElement.srcObject = stream;

                // Stream video frames to Flask-SocketIO every 5000ms (5 seconds)
                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');

                setInterval(() => {
                    if (videoElement.readyState === videoElement.HAVE_ENOUGH_DATA) {
                        canvas.width = videoElement.videoWidth;
                        canvas.height = videoElement.videoHeight;
                        context.drawImage(videoElement, 0, 0, canvas.width, canvas.height);
                        const dataURL = canvas.toDataURL('image/jpeg'); // Send image data
                        socket.emit('video_stream', { frame: dataURL });
                    }
                }, 2000);

            } catch (err) {
                console.error("Error accessing webcam: ", err);
                alert("Could not start webcam. Please ensure permissions are granted.");
            }
        }

        // --- GLOBAL SETUP ---

        function initializeVTA() {
            console.log('Initializing VTA interface...');
            feather.replace();
            initializeSocketIO();
            loadUserProfileData();
            fetchRecentSessions();

            // Send message button
            document.getElementById('send-message-btn').addEventListener('click', () => {
                const message = document.getElementById('user-input').value;
                sendMessage(message);
            });

            // Enter key to send message
            document.getElementById('user-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    sendMessage(document.getElementById('user-input').value);
                }
            });

            // New session button
            document.getElementById('new-session-btn').addEventListener('click', startNewSession);

            // Profile icon
            document.getElementById('profile-icon').addEventListener('click', function () {
                const summaryContent = document.getElementById('stage-5').querySelector('.gateway-form').innerHTML;
                document.getElementById('modal-summary-content').innerHTML = summaryContent;

                populateProfileSummary();

                document.getElementById('modal-summary-content').querySelector('.space-y-4')?.classList.add('hidden');
                document.getElementById('profile-modal').classList.remove('hidden');
                feather.replace();
            });

            // Send message button and Enter key listeners
            document.getElementById('send-message-btn').addEventListener('click', () => {
                const message = document.getElementById('user-input').value;
                sendMessage(message);
            });

            document.getElementById('user-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    sendMessage(document.getElementById('user-input').value);
                }
            });

            // Start webcam button
            document.getElementById('start-webcam-btn').addEventListener('click', startWebcamStream);

            // Sidebar toggle buttons
            document.getElementById('sidebar-open-btn').addEventListener('click', () => {
                document.getElementById('sidebar').classList.remove('-translate-x-full');
            });

            document.getElementById('sidebar-close-btn').addEventListener('click', () => {
                document.getElementById('sidebar').classList.add('-translate-x-full');
            });

            // Set user greeting from session check
            fetch('http://127.0.0.1:5000/check_session')
                .then(response => response.json())
                .then(data => {
                    if (data.is_authenticated) {
                        document.getElementById('user-greeting-vta').textContent = data.username;
                    }
                });

            console.log('VTA initialized successfully');
        }

        function initializePage() {
            AOS.init({ duration: 800, easing: 'ease-in-out', once: true });
            feather.replace();

            VANTA.GLOBE({
                el: "#vanta-bg",
                mouseControls: true,
                touchControls: true,
                gyroControls: false,
                minHeight: 200.00,
                minWidth: 200.00,
                scale: 1.00,
                scaleMobile: 1.00,
                color: 0x3f3f6f,
                backgroundColor: 0x111827,
                size: 0.8
            });

            // Check login status on every page load
            checkLoginStatus();
        }
        window.onload = initializePage;

    </script>
</body>

</html>